<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DAASS â€” Walk-In Registration</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="register.css" />
</head>

<body>

    <header>
        <div class="logo">
            <div class="logo-mark">WI</div>
            <div>
                <div class="logo-text">DAASS</div>
                <div class="logo-sub">Walk-In Registration</div>
            </div>
        </div>
        <nav class="nav-links">
            <a href="index.html" class="nav-link">Dashboard</a>
            <a href="register.html" class="nav-link active">Walk-In</a>
            <a href="book.html" class="nav-link">Online Booking</a>
        </nav>
    </header>

    <div class="page">
        <div class="page-header">
            <div class="page-tag">Staff Portal Â· Walk-In</div>
            <div class="page-title">Register Walk-In Patient</div>
            <div class="page-desc">Enter patient details. The scheduling engine will automatically assign priority and
                estimated consultation time.</div>
        </div>

        <div class="form-card">
            <div class="form-card-header">
                <div class="form-card-header-dot"></div>
                <div class="form-card-title">Patient Details</div>
            </div>

            <!-- FORM -->
            <div class="form-body" id="form-body">
                <div class="form-grid">

                    <div class="form-row form-full">
                        <label>Full Name *</label>
                        <input id="name" type="text" placeholder="Patient full name" />
                    </div>

                    <div class="form-row">
                        <label>Age *</label>
                        <input id="age" type="number" placeholder="Years" min="1" max="120" />
                    </div>

                    <div class="form-row">
                        <label>Phone</label>
                        <input id="phone" type="tel" placeholder="Optional" />
                    </div>

                    <div class="form-row form-full">
                        <label>Symptom Category *</label>
                        <select id="symptom" onchange="updatePreview()">
                            <option value="" disabled selected>Select primary symptom...</option>
                            <option value="chest_pain">ðŸ”´ Chest Pain / Breathing Difficulty</option>
                            <option value="trauma">ðŸ”´ Trauma / Injury / Accident</option>
                            <option value="high_fever">ðŸŸ  High Fever (above 103Â°F)</option>
                            <option value="pregnancy">ðŸŸ  Pregnancy Related</option>
                            <option value="fever_cold">ðŸŸ¡ Fever / Cold / Flu</option>
                            <option value="stomach">ðŸŸ¡ Abdominal Pain / Vomiting</option>
                            <option value="diabetes_bp">ðŸŸ¢ Diabetes / BP Follow-up</option>
                            <option value="routine">ðŸŸ¢ Routine Checkup</option>
                            <option value="other">âšª Other</option>
                        </select>
                    </div>

                    <div class="form-row form-full">
                        <label>Pain Level (1 = mild, 10 = severe)</label>
                        <input id="pain" type="number" min="1" max="10" placeholder="Rate 1â€“10"
                            onchange="updatePreview()" oninput="updatePreview()" />
                    </div>

                    <div class="form-row form-full">
                        <label>Emergency?</label>
                        <select id="emergency">
                            <option value="walkin">No â€” Regular Walk-In</option>
                            <option value="emergency">Yes â€” Emergency / Urgent</option>
                        </select>
                    </div>

                </div>

                <hr class="divider" />

                <!-- PRIORITY PREVIEW -->
                <div class="priority-preview" id="priority-preview">
                    <div class="pp-label">Scheduling Engine Preview</div>
                    <div class="pp-row">
                        <span class="pp-key">Priority Class</span>
                        <span class="pp-val" id="pp-priority">â€”</span>
                    </div>
                    <div class="pp-row">
                        <span class="pp-key">Urgency Score</span>
                        <span class="pp-val" id="pp-score">â€”</span>
                    </div>
                    <div class="pp-row">
                        <span class="pp-key">Est. Consult Time</span>
                        <span class="pp-val" id="pp-time">â€”</span>
                    </div>
                </div>

                <button class="submit-btn" id="submit-btn" onclick="submitPatient()">
                    Register & Add to Queue
                </button>
            </div>

            <!-- SUCCESS -->
            <div class="success-screen" id="success-screen">
                <div class="success-icon">âœ“</div>
                <div class="success-title">Patient Registered</div>
                <div class="success-desc">Successfully added to the queue. Doctor's dashboard will update automatically.
                </div>

                <div class="token-box" id="token-box"></div>

                <button class="reset-btn" onclick="resetForm()">Register Next Patient</button>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toast-container"></div>

    <script>
        const API = 'http://localhost:3000/api';

        // â”€â”€â”€ Scheduling logic (mirrored from backend for preview) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const SYMPTOM_MAP = {
            chest_pain: { priority: 1, time: 12 }, trauma: { priority: 1, time: 15 },
            high_fever: { priority: 2, time: 10 }, pregnancy: { priority: 2, time: 12 },
            fever_cold: { priority: 3, time: 7 }, stomach: { priority: 3, time: 8 },
            diabetes_bp: { priority: 4, time: 6 }, routine: { priority: 4, time: 5 },
            other: { priority: 3, time: 7 },
        };

        function computeScore(symptom, age, pain, type) {
            const s = SYMPTOM_MAP[symptom] || { priority: 3, time: 7 };
            let score = (5 - s.priority) * 25;
            if (type === 'emergency') score += 50;
            if (age >= 65 || age <= 5) score += 15;
            else if (age >= 50) score += 8;
            score += (parseInt(pain) || 1) * 2;
            return Math.min(score, 100);
        }

        function estimateTime(symptom, age, pain, type) {
            const s = SYMPTOM_MAP[symptom] || { priority: 3, time: 7 };
            let t = s.time;
            if (age >= 65 || age <= 5) t += 3;
            if (type === 'emergency') t += 3;
            if ((parseInt(pain) || 1) >= 8) t += 2;
            return t;
        }

        function getPClass(score) {
            if (score >= 70) return 1;
            if (score >= 50) return 2;
            if (score >= 30) return 3;
            return 4;
        }

        function updatePreview() {
            const symptom = document.getElementById('symptom').value;
            const age = parseInt(document.getElementById('age').value) || 30;
            const pain = parseInt(document.getElementById('pain').value) || 1;
            const type = document.getElementById('emergency').value;

            if (!symptom) return;

            const score = computeScore(symptom, age, pain, type);
            const pclass = getPClass(score);
            const time = estimateTime(symptom, age, pain, type);

            const pLabels = { 1: 'Emergency', 2: 'Severe', 3: 'Moderate', 4: 'Mild' };
            const pCls = { 1: 'p1', 2: 'p2', 3: 'p3', 4: 'p4' };

            document.getElementById('pp-priority').innerHTML =
                `<span class="priority-pill ${pCls[pclass]}">P${pclass} â€” ${pLabels[pclass]}</span>`;
            document.getElementById('pp-score').textContent = `${score} / 100`;
            document.getElementById('pp-time').textContent = `~${time} minutes`;

            document.getElementById('priority-preview').classList.add('show');
        }

        document.getElementById('age').addEventListener('input', updatePreview);
        document.getElementById('emergency').addEventListener('change', updatePreview);

        // â”€â”€â”€ Submit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function submitPatient() {
            const name = document.getElementById('name').value.trim();
            const age = document.getElementById('age').value;
            const phone = document.getElementById('phone').value.trim();
            const symptom = document.getElementById('symptom').value;
            const pain = document.getElementById('pain').value || 1;
            const type = document.getElementById('emergency').value;

            if (!name || !age || !symptom) {
                showToast('Please fill all required fields', 'error');
                return;
            }

            const btn = document.getElementById('submit-btn');
            btn.disabled = true;
            btn.textContent = 'Registering...';

            try {
                const res = await fetch(`${API}/patients`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, age: parseInt(age), phone, symptom, pain: parseInt(pain), type }),
                });

                const data = await res.json();

                if (!res.ok) throw new Error(data.error || 'Registration failed');

                const p = data.patient;
                const pLabels = { 1: 'Emergency', 2: 'Severe', 3: 'Moderate', 4: 'Mild' };

                document.getElementById('token-box').innerHTML = `
      <div class="token-label">Registration Summary</div>
      <div class="token-row"><span class="token-key">Name</span><span class="token-val">${p.name}</span></div>
      <div class="token-row"><span class="token-key">Priority</span><span class="token-val">P${p.priorityClass} â€” ${pLabels[p.priorityClass]}</span></div>
      <div class="token-row"><span class="token-key">Est. Time</span><span class="token-val">${p.estimatedTime} min</span></div>
      <div class="token-row"><span class="token-key">Token ID</span><span class="token-val" style="font-family:'DM Mono',monospace;font-size:11px">${p._id.slice(-8).toUpperCase()}</span></div>
    `;

                document.getElementById('form-body').classList.add('hide');
                document.getElementById('success-screen').classList.add('show');

            } catch (err) {
                showToast(err.message, 'error');
                btn.disabled = false;
                btn.textContent = 'Register & Add to Queue';
            }
        }

        function resetForm() {
            document.getElementById('form-body').classList.remove('hide');
            document.getElementById('success-screen').classList.remove('show');
            document.getElementById('priority-preview').classList.remove('show');
            ['name', 'age', 'phone', 'pain'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('symptom').value = '';
            document.getElementById('emergency').value = 'walkin';
            document.getElementById('submit-btn').disabled = false;
            document.getElementById('submit-btn').textContent = 'Register & Add to Queue';
        }

        function showToast(msg, type = 'error') {
            const c = document.getElementById('toast-container');
            const t = document.createElement('div');
            t.className = `toast ${type}`;
            t.innerHTML = `<span>${type === 'success' ? 'âœ“' : 'âœ—'}</span><span>${msg}</span>`;
            c.appendChild(t);
            setTimeout(() => t.remove(), 3500);
        }
    </script>
</body>

</html>